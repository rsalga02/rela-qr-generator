<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>RELA QR Code Generator</title>
  <style>
    :root { --gap: 12px; --radius: 12px; }
    * { box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; margin:0; background:#f8fafc; color:#0f172a;}
    header { background:#fff; border-bottom:1px solid #e2e8f0; padding:16px 18px; position:sticky; top:0; z-index:10; display:flex; gap:12px; align-items:center;}
    .logo { width:40px; height:40px; border-radius:10px; display:grid; place-items:center; background:#0ea5e9; color:#fff; font-weight:800;}
    .container { max-width:900px; margin:20px auto 40px; padding:0 16px;}
    .card { background:#fff; border:1px solid #e2e8f0; border-radius:12px; padding:18px; box-shadow:0 10px 18px rgba(15,23,42,0.05);}
    form { display:grid; gap:12px;}
    label { font-size:14px; color:#334155;}
    input, select, textarea, button { width:100%; padding:12px 14px; border-radius:10px; border:1px solid #cbd5e1; font-size:16px; background:#fff;}
    input:focus, select:focus, textarea:focus { outline:2px solid #0ea5e980;}
    .row { display:grid; gap:12px;}
    @media(min-width:720px){ .row.two{ grid-template-columns:1fr 1fr; } }
    .actions { display:flex; gap:10px; flex-wrap:wrap; }
    .btn { border:0; padding:12px 16px; border-radius:10px; cursor:pointer; }
    .btn-primary { background:#0ea5e9; color:#fff; }
    .btn-secondary { background:#f1f5f9; color:#0f172a; border:1px solid #e2e8f0; }
    .qr-wrap { display:grid; gap:18px; margin-top:16px; }
    @media(min-width:900px){ .qr-wrap{ grid-template-columns:1fr 1fr; } }
    .qr-box { border:1px dashed #cbd5e1; border-radius:12px; background:#fafafa; min-height:320px; display:grid; place-items:center; padding:16px;}
    .caption { color:#475569; font-size:14px; text-align:center;}
    footer { text-align:center; color:#64748b; padding:24px 16px 60px; font-size:14px;}
    .note { font-size:13px; color:#475569; }
    canvas { display:none; }
  </style>
</head>
<body>
  <header>
    <div class="logo">RL</div>
    <div>
      <div style="font-weight:700;">RELA QR Code Generator</div>
      <div class="note">Generates a QR that opens an SMS draft on iPhone. Uses Google Chart API for the QR image.</div>
    </div>
  </header>

  <div class="container">
    <div class="card">
      <form id="qrForm">
        <div class="row two">
          <div>
            <label for="address">Customer address (used for filename)</label>
            <input id="address" placeholder="2827 Old Glory Dr, Yorkville, IL 60560" required>
          </div>
          <div>
            <label for="pickup">Garbage pickup day</label>
            <select id="pickup" required>
              <option value="" disabled selected>Select day</option>
              <option>Monday</option><option>Tuesday</option><option>Wednesday</option>
              <option>Thursday</option><option>Friday</option><option>Saturday</option>
            </select>
          </div>
        </div>
        <div class="row two">
          <div>
            <label for="phone">Your phone number (receives the SMS)</label>
            <input id="phone" inputmode="tel" placeholder="+16303644345">
          </div>
          <div>
            <label for="extra">Optional note to include</label>
            <input id="extra" placeholder="e.g., 2 trash, 1 recycle bin">
          </div>
        </div>
        <div>
          <label for="prefix">Message prefix (editable)</label>
          <textarea id="prefix" rows="2">My bins need a cleaning.</textarea>
        </div>
        <div class="actions">
          <button class="btn btn-primary" type="submit" id="genBtn">Generate QR</button>
          <button class="btn btn-secondary" type="button" id="downloadBtn" disabled>Download PNG</button>
          <button class="btn btn-secondary" type="button" id="clearBtn">Clear</button>
        </div>
      </form>

      <div class="qr-wrap">
        <div class="qr-box" id="qrcodeBox">
          <div class="caption">Your QR will appear here.</div>
          <img id="qrImg" alt="" style="max-width:100%; height:auto; display:none;" crossorigin="anonymous">
          <canvas id="qrCanvas" width="520" height="520"></canvas>
        </div>
        <div>
          <div class="note"><strong>What it does:</strong> Creates a QR image via <code>chart.googleapis.com</code> and lets you download a PNG.</div>
          <ul class="note">
            <li>If you update the page and don’t see changes, add <code>?v=3</code> to the URL to bypass cache.</li>
            <li>Make sure you’re online when generating (QR image is fetched from Google).</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <footer>© <span id="yr"></span> RELA Rentals</footer>

  <script>
    const elBox = document.getElementById('qrcodeBox');
    const genBtn = document.getElementById('genBtn');
    const dlBtn = document.getElementById('downloadBtn');
    const clearBtn = document.getElementById('clearBtn');
    const yr = document.getElementById('yr');
    const img = document.getElementById('qrImg');
    const canvas = document.getElementById('qrCanvas');
    const ctx = canvas.getContext('2d');
    yr.textContent = new Date().getFullYear();

    function sanitizeFilename(s) {
      return s.replace(/[^a-z0-9\-\_\(\)\[\]\s,\.]/gi,'').trim().replace(/\s+/g,' ');
    }

    function buildSMSURI(phone, body) {
      const p = (phone || '').trim();
      const urlBody = encodeURIComponent(body);
      return `sms:${encodeURIComponent(p)}&body=${urlBody}`;
    }

    function makeBody(prefix, address, pickup, extra) {
      const lines = [];
      if (prefix && prefix.trim()) lines.push(prefix.trim());
      if (address && address.trim()) lines.push(`My address is: ${address.trim()}`);
      if (pickup && pickup.trim()) lines.push(`My garbage pick up day is ${pickup.trim()}.`);
      if (extra && extra.trim()) lines.push(extra.trim());
      lines.push('Please confirm you’re available and send me a link for payment.');
      return lines.join(' ');
    }

    function generateQR(e) {
      e && e.preventDefault();
      const address = document.getElementById('address').value;
      const day = document.getElementById('pickup').value;
      const phone = document.getElementById('phone').value;
      const extra = document.getElementById('extra').value;
      const prefix = document.getElementById('prefix').value;

      if (!address || !day) { alert('Address and pickup day are required.'); return; }
      const body = makeBody(prefix, address, day, extra);
      const smsURI = buildSMSURI(phone, body);

      const size = 520;
      const api = 'https://chart.googleapis.com/chart?cht=qr&chs=' + size + 'x' + size + '&chl=' + encodeURIComponent(smsURI);
      img.onload = () => {
        try {
          canvas.width = size;
          canvas.height = size;
          ctx.clearRect(0,0,size,size);
          ctx.drawImage(img, 0, 0, size, size);
          dlBtn.disabled = false;
        } catch (err) {
          console.error(err);
          dlBtn.disabled = true;
        }
      };
      img.onerror = () => {
        alert('Could not load QR image. Check your internet connection.');
        dlBtn.disabled = true;
      };
      img.src = api;
      img.style.display = 'block';
      elBox.querySelector('.caption')?.remove();
    }

    function downloadPNG() {
      const address = document.getElementById('address').value || 'qr';
      const filename = sanitizeFilename(address || 'qr') + '.png';
      const link = document.createElement('a');
      link.download = filename;
      link.href = canvas.toDataURL('image/png');
      document.body.appendChild(link);
      link.click();
      setTimeout(()=>document.body.removeChild(link),0);
    }

    function clearAll() {
      document.getElementById('qrForm').reset();
      const oldCap = document.createElement('div');
      oldCap.className = 'caption';
      oldCap.textContent = 'Your QR will appear here.';
      elBox.innerHTML = '';
      elBox.appendChild(oldCap);
      elBox.appendChild(img);
      elBox.appendChild(canvas);
      img.style.display = 'none';
      img.src = '';
      const ctx2 = canvas.getContext('2d');
      ctx2.clearRect(0,0,canvas.width,canvas.height);
      dlBtn.disabled = true;
    }

    document.getElementById('qrForm').addEventListener('submit', generateQR);
    dlBtn.addEventListener('click', downloadPNG);
    clearBtn.addEventListener('click', clearAll);
  </script>
</body>
</html>
